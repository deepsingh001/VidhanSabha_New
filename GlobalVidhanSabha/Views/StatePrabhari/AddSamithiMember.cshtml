@{
    Layout = "~/Views/Shared/_PrabhariLayout.cshtml";
}

<style>
    /* Table ka font chota karne ke liye */
    .table-compact-custom {
        font-size: 0.85rem;
    }

        /* Padding kam karke row ki height ghatane ke liye */
        .table-compact-custom td,
        .table-compact-custom th {
            padding: 6px 10px !important;
            vertical-align: middle;
        }

    .sno-col {
        width: 50px;
        text-align: center;
    }

    .btn-navy {
        background-color: #002147;
        color: white;
    }

        .btn-navy:hover {
            background-color: #001630;
            color: white;
        }
        .custom-modal {
    max-width: 800px; 
}

    @@media (max-width: 992px) {
        .custom-modal {
            max-width: 95%; 
        }
    }
 
    #vidhanSabhaModal .modal-header {
        background-color: #002147 !important;
        color: #fff !important;
    }

</style>

<div class="card border-0 shadow-sm rounded-3">
    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold" style="color:#002147;">Samithi Member List</h6>
        <button class="btn btn-sm btn-navy py-1 px-3" data-bs-toggle="modal" data-bs-target="#vidhanSabhaModal">
            <i class="bi bi-plus-lg me-1"></i>Add Samithi Member
        </button>
    </div>

    <div class="card-body p-2">
        <div class="table-responsive">
            <table id="memberTable" class="table table-hover table-bordered table-sm table-compact-custom w-100">
                <thead class="table-light">
                    <tr>
                        <th class="text-center sno-col">S.No</th>
                        <th>Designation Type</th>
                        <th>Designation Name</th>
                        <th>Samithi Member</th>
                        <th>Email</th>
                        <th class="text-center">Contact</th>
                        <th>Address</th>
                        <th>Profession</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="vidhanSabhaModal" tabindex="-1">
    <div class="modal-dialog custom-modal">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-navy text-white py-2 px-3">
                <h6 class="modal-title fw-bold" id="modalTitle">Samithi Member Registration</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="samithiForm" enctype="multipart/form-data">
                    <input type="hidden" id="memberId" name="Id" />

                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Select Designation</label>
                            <select class="form-select form-select-sm" id="DesignationType" name="DesignationType" required>
                                <option value="">-- Select Designation --</option>
                            </select>
                        </div>
                

                    
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Select Designation Name</label>
                            <select class="form-select form-select-sm" id="DesignationNameId" name="DesignationNameId" required>
                                <option value="">-- Select Designation Name--</option>
                            </select>
                        </div>
                    </div>

                    <div id="samithiMemberDetails" class="p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Samithi Member Name</label>
                                <input type="text" class="form-control form-control-sm" id="Name" name="SamithiMember" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Email</label>
                                <input type="email" class="form-control form-control-sm" id="Email" name="Email" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Phone No</label>
                                <input type="tel" class="form-control form-control-sm" id="PhoneNo" name="PhoneNo" required>

                                <span id="phoneError" style="color:red; font-size:13px; display:none;">
                                    Add 10 digit contact number
                                </span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Category</label>
                                <select class="form-select form-select-sm" id="Category" name="Category" required>
                                    <option value="">--Select Category--</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Sub Caste</label>
                                <select class="form-select form-select-sm" id="Caste" name="Caste" required>
                                    <option value="">--Select Sub Caste--</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Education</label>
                                <input type="text" class="form-control form-control-sm" id="Education" name="Education">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Profession</label>
                                <input type="text" class="form-control form-control-sm" id="Profession" name="Profession">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Profile</label>
                                <input type="file" class="form-control form-control-sm" id="Profile" name="Profile">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Address</label>
                                <textarea class="form-control form-control-sm" id="Address" name="Address" rows="1"></textarea>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-navy btn-sm w-100 fw-bold py-2">
                        Save Registration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/jquery-3.7.0.min.js"></script>


<script>
    $(document).ready(function () {

        $('#PhoneNo').on('input', function () {

            // Sirf number allow karega
            this.value = this.value.replace(/[^0-9]/g, '');

            var phone = this.value;

            if (phone.length !== 10) {
                $('#phoneError').show();
            } else {
                $('#phoneError').hide();
            }

        });

        // Initialize DataTable
        var memberTable = $('#memberTable').DataTable({
            serverSide: true,
            processing: true,
            ajax: function (data, callback, settings) {
               
                var pageNumber = Math.floor(data.start / data.length) + 1;
                var pageSize = data.length;

                $.ajax({
                    url: '/api/samithimember/getall',
                    type: 'GET',
                    data: {
                        PageNumber: pageNumber,
                        Items: pageSize,
                        search: data.search.value // optional search value
                    },
                    success: function (res) {
                        callback({
                            recordsTotal: res.data.length,   // total items in current response
                            recordsFiltered: res.data.length,
                            data: res.data                   // actual array
                        });
                    }
                });
            },
            columns: [
                { data: null, className: 'text-center', render: (data, type, row, meta) => meta.row + 1 },
                { data: 'DesignationTypeName', defaultContent: '-' },
                { data: 'DesignationName', defaultContent: '-' },
                { data: 'SamithiMember', defaultContent: '-' },
                { data: 'Email', defaultContent: '-' },
                { data: 'PhoneNo', defaultContent: '-' },
                { data: 'Address', defaultContent: '-' },
                { data: 'Profession', defaultContent: '-' },
                {
                    data: null,
                    className: 'text-center',
                    render: function (data, type, row) {
                        return '<button class="btn btn-sm btn-light edit-btn" data-id="' + row.Id + '"><i class="bi bi-pencil-square text-primary"></i></button> ' +
                            '<button class="btn btn-sm btn-light delete-btn" data-id="' + row.Id + '"><i class="bi bi-trash text-danger"></i></button>';
                    }
                }
            ],
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50]
        });
        // Reload Members function
        function loadMembers() {
            memberTable.ajax.reload();
        }

        // Load dropdowns
        loadDesignation();
        loadDesignationNames();
        loadCategories();

        $("#Category").change(function () {
            var categoryId = $(this).val();
            loadSubCastes(categoryId);
        });

        // Form submit
        $('#samithiForm').on('submit', function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: '/api/samithimember/save',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,

                success: function (response) {

                    if (response.success) {

                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: response.message,
                            confirmButtonColor: '#002147'
                        });

                        $('#vidhanSabhaModal').modal('hide');
                        loadMembers();
                        $('#samithiForm')[0].reset();
                        $('#memberId').val('');

                    } else {

                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message || response.error,
                            confirmButtonColor: '#002147'
                        });

                    }
                },

                error: function (xhr) {

                    var message = "Something went wrong";

                    if (xhr.responseJSON) {
                        message = xhr.responseJSON.error || xhr.responseJSON.message;
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message,
                        confirmButtonColor: '#002147'
                    });

                }

            });
        });

        // Edit Member
        $(document).on('click', '.edit-btn', function () {
            var id = $(this).data('id');
            $.ajax({
                url: '/api/samithimember/get/' + id,
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        var member = response.data;
                        $('#memberId').val(member.Id);
                        $('#DesignationType').val(member.DesignationType);

                        // 👇 IMPORTANT FIX
                        setTimeout(function () {

                            $("#DesignationNameId option").each(function () {

                                if ($(this).text().trim() === member.DesignationName?.trim()) {

                                    $(this).prop('selected', true);

                                }

                            });

                        }, 300);

                        $('#Name').val(member.SamithiMember);
                        $('#Email').val(member.Email);
                        $('#PhoneNo').val(member.PhoneNo);
                        $('#Education').val(member.Education);
                        $('#Profession').val(member.Profession);
                        $('#Address').val(member.Address);
                        $('#Category').val(member.Category);
                        loadSubCastes(member.Category, member.Caste);
                        $('#vidhanSabhaModal').modal('show');
                    }
                }
            });
        });

        // Delete Member
        $(document).on('click', '.delete-btn', function () {
            var id = $(this).data('id');
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#002147',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/api/samithimember/delete/' + id,
                        type: 'DELETE',
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({ icon: 'success', title: 'Deleted', text: response.message, confirmButtonColor: '#002147' });
                                loadMembers();
                            } else {
                                Swal.fire({ icon: 'error', title: 'Error', text: response.message });
                            }
                        },
                        error: function () {
                            Swal.fire({ icon: 'error', title: 'Error', text: 'Delete failed' });
                        }
                    });
                }
            });
        });

        // ---------- Load Designation ----------
        function loadDesignation() {
            $.ajax({
                url: '/api/Admin/GetDesignationType',
                type: "GET",
                success: function (response) {
                    if (response.success) {
                        var dropdown = $("#DesignationType");
                        dropdown.empty().append('<option value="">-- Select Designation --</option>');
                        if (response.data.length && typeof response.data[0] === 'string') {
                            $.each(response.data, function (index, item) {
                                dropdown.append('<option value="' + item + '">' + item + '</option>');
                            });
                        } else {
                            $.each(response.data, function (index, item) {
                                dropdown.append('<option value="' + item.DesignationId + '">' + item.DesignationType + '</option>');
                            });
                        }
                    }
                }
            });
        }

        // ---------- Load Designation Name ----------
        function loadDesignationNames() {
            $.ajax({
                url: '/api/Admin/getAllDesignation?PageNumber=1&Items=100&search=',
                type: "GET",
                success: function (response) {

                    var dropdown = $("#DesignationNameId");

                    dropdown.empty().append('<option value="">-- Select Designation Name --</option>');

                    $.each(response.data.data, function (index, item) {

                        dropdown.append(
                            '<option value="' + item.DesignationId + '">' +
                            item.DesignationName +
                            '</option>'
                        );

                    });
                }
            });
        }

        // ---------- Load Categories ----------
        function loadCategories() {
            $.ajax({
                url: '/api/Admin/GetCasteCategory',
                type: "GET",
                success: function (response) {
                    if (response.success) {
                        var dropdown = $("#Category");
                        dropdown.empty().append('<option value="">-- Select Category --</option>');
                        $.each(response.data.data, function (index, item) {
                            dropdown.append('<option value="' + item.Id + '">' + item.Name + '</option>');
                        });
                    }
                }
            });
        }

        // ---------- Load Sub Castes ----------
        function loadSubCastes(categoryId, selectedCasteId = null) {
            if (!categoryId) {
                $("#Caste").empty().append('<option value="">-- Select Sub Caste --</option>');
                return;
            }
            $.ajax({
                url: '/api/Admin/GetSubCasteByCategory?categoryId=' + categoryId,
                type: "GET",
                success: function (response) {
                    if (response.success) {
                        var dropdown = $("#Caste");
                        dropdown.empty().append('<option value="">-- Select Sub Caste --</option>');
                        $.each(response.data.data, function (index, item) {
                            dropdown.append('<option value="' + item.Id + '">' + item.Name + '</option>');
                        });
                        if (selectedCasteId != null) dropdown.val(selectedCasteId);
                    }
                }
            });
        }

    });
</script>