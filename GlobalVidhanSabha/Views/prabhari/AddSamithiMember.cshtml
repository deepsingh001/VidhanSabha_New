@{
    Layout = "~/Views/Shared/_PrabhariLayout.cshtml";
}

<style>
    /* your existing styles */
    .bg-navy {
        background: #001a35 !important;
    }

    .btn-navy {
        background: #002147;
        color: #fff;
    }

        .btn-navy:hover {
            background: #001a35;
            color: #fff;
        }

    .custom-modal {
        max-width: 750px;
        margin-top: 65px;
    }

    .form-check-input:checked {
        background-color: #002147 !important;
        border-color: #002147 !important;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.15rem rgba(0, 33, 71, 0.25) !important;
        border-color: #002147 !important;
    }
    .table thead th {
        background-color: #002147 !important;
        color: #ffffff !important;
        text-align: center;
    }

</style>

<div class="card border-0 shadow-sm rounded-3">
    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold" style="color:#002147;">Samithi Member List</h6>
        <button class="btn btn-sm btn-navy py-1 px-3" data-bs-toggle="modal" data-bs-target="#vidhanSabhaModal">
            <i class="bi bi-plus-lg me-1"></i>Add Samithi Member
        </button>
    </div>

    <div class="card-body p-2">
        <div class="table-responsive">
            <table class="table table-hover table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">S.No</th>
                        @*<th>State</th>
                        <th>District</th>
                        <th>Vidhan Sabha</th>*@
                    <th>Samithi Member</th>
                        <th>Email</th>
                        <th>Contact</th>
                        <th>Address</th>
                        <th>Profession</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here via AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="vidhanSabhaModal" tabindex="-1">
    <div class="modal-dialog custom-modal">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-navy text-white py-2 px-3">
                <h6 class="modal-title fw-bold" id="modalTitle">Samithi Member Registration</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="samithiForm" enctype="multipart/form-data">
                    <!-- Hidden ID for editing -->
                    <input type="hidden" id="memberId" name="Id" />

                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Select Designation</label>
                            <select class="form-select form-select-sm" id="DesignationType" name="DesignationType" required>
                                <option value="">-- Select Designation --</option>
                            </select>
                        </div>
                        <!-- You can add State/District/Vidhan Sabha fields here if needed -->
                    </div>

                    <div id="samithiMemberDetails" class="p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Samithi Member Name</label>
                                <input type="text" class="form-control form-control-sm" id="Name" name="SamithiMember" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Email</label>
                                <input type="email" class="form-control form-control-sm" id="Email" name="Email" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Phone No</label>
                                <input type="text" class="form-control form-control-sm" id="PhoneNo" name="PhoneNo" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Category</label>
                                <select class="form-select form-select-sm" id="Category" name="Category" required>
                                    <option value="">--Select Category--</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Sub Caste</label>
                                <select class="form-select form-select-sm" id="Caste" name="Caste" required>
                                    <option value="">--Select Sub Caste--</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Education</label>
                                <input type="text" class="form-control form-control-sm" id="Education" name="Education">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Profession</label>
                                <input type="text" class="form-control form-control-sm" id="Profession" name="Profession">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Profile</label>
                                <input type="file" class="form-control form-control-sm" id="Profile" name="Profile">                               
                            </div>

                            <div class="col-md-12">
                                <label class="form-label small fw-bold text-muted">Address</label>
                                <textarea class="form-control form-control-sm" id="Address" name="Address" rows="1"></textarea>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-navy btn-sm w-100 fw-bold py-2">
                        Save Registration
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/jquery-3.7.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Load dropdowns
        loadDesignation();
        loadCategories();
      

        // Load existing members
        loadMembers();

        $("#Category").change(function () {

            var categoryId = $(this).val();

            loadSubCastes(categoryId);

        });


        // Form submit
        $('#samithiForm').on('submit', function (e) {
            e.preventDefault();

            var formData = new FormData(this); // includes file if selected

            $.ajax({
                url: '/api/samithimember/save',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {

                    if (response.success) {

                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: response.message, // API message
                            confirmButtonColor: '#002147'
                        });

                        $('#vidhanSabhaModal').modal('hide');

                        loadMembers();

                        $('#samithiForm')[0].reset();

                        $('#memberId').val('');

                    } else {

                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message || 'Something went wrong',
                            confirmButtonColor: '#002147'
                        });

                    }

                }              
            });
        });
    });

    // ---------- Load Designation ----------
    function loadDesignation() {
        $.ajax({
            url: '/api/Admin/GetDesignationType',
            type: "GET",
            success: function (response) {
                if (response.success) {
                    var dropdown = $("#DesignationType");
                    dropdown.empty().append('<option value="">-- Select Designation --</option>');

                    // Check if data is array of strings or objects
                    if (response.data.length && typeof response.data[0] === 'string') {
                        // Array of strings
                        $.each(response.data, function (index, item) {
                            dropdown.append('<option value="' + item + '">' + item + '</option>');
                        });
                    } else {
                        // Array of objects with Id and Name
                        $.each(response.data, function (index, item) {
                            dropdown.append('<option value="' + item.DesignationId + '">' + item.DesignationType + '</option>');
                        });
                    }
                }
            },
            error: function (err) {
                console.error("Error loading designation", err);
            }
        });
    }

    // ---------- Load Categories (adjust URL as needed) ----------
    function loadCategories() {
        $.ajax({
            url: '/api/Admin/GetCasteCategory',
            type: "GET",
            success: function (response) {

                if (response.success) {

                    var dropdown = $("#Category");
                    dropdown.empty();

                    dropdown.append('<option value="">-- Select Category --</option>');

                    $.each(response.data.data, function (index, item) {

                        dropdown.append(
                            '<option value="' + item.Id + '">' + item.Name + '</option>'
                        );

                    });

                }

            },
            error: function (err) {
                console.error("Error loading categories", err);
            }
        });
    }


    // ---------- Load Castes (adjust URL as needed) ----------
    function loadSubCastes(categoryId, selectedCasteId = null) {

        if (!categoryId) {
            $("#Caste").empty().append('<option value="">-- Select Sub Caste --</option>');
            return;
        }

        $.ajax({

            url: '/api/Admin/GetSubCasteByCategory?categoryId=' + categoryId,

            type: "GET",

            success: function (response) {

                if (response.success) {

                    var dropdown = $("#Caste");

                    dropdown.empty();

                    dropdown.append('<option value="">-- Select Sub Caste --</option>');

                    $.each(response.data.data, function (index, item) {

                        dropdown.append(
                            '<option value="' + item.Id + '">' + item.Name + '</option>'
                        );

                    });

                    // ✅ THIS LINE IS MOST IMPORTANT
                    if (selectedCasteId != null) {

                        dropdown.val(selectedCasteId);

                    }

                }

            }

        });

    }



    // ---------- Load Members into Table ----------
    function loadMembers() {
        $.ajax({
            url: '/api/samithimember/getall',
            type: 'GET',
            success: function (response) {
                if (response.success) {
                    var tbody = $('table tbody');
                    tbody.empty();

                    if (!response.data || response.data.length === 0) {
                        tbody.append('<tr><td colspan="8" class="text-center">No records found</td></tr>');
                        return;
                    }

                    $.each(response.data, function (index, member) {
                        var row = '<tr>' +
                            '<td class="text-center">' + (index + 1) + '</td>' +
                            //'<td>' + (member.State || '-') + '</td>' +
                            //'<td>' + (member.District || '-') + '</td>' +
                            //'<td>' + (member.VidhanSabha || '-') + '</td>' +
                            '<td>' + (member.SamithiMember || '-') + '</td>' +
                            '<td>' + (member.Email || '-') + '</td>' +
                            '<td>' + (member.PhoneNo || '-') + '</td>' +
                            '<td>' + (member.Address || '-') + '</td>' +
                            '<td>' + (member.Profession || '-') + '</td>' +
                            '<td class="text-center">' +
                            '<button class="btn btn-sm btn-light edit-btn" data-id="' + member.Id + '"><i class="bi bi-pencil-square text-primary"></i></button> ' +
                            '<button class="btn btn-sm btn-light delete-btn" data-id="' + member.Id + '"><i class="bi bi-trash text-danger"></i></button>' +
                            '</td>' +
                            '</tr>';
                        tbody.append(row);
                    });
                }
            },
            error: function (err) {
                console.error('Error loading members', err);
            }
        });
    }

    // ---------- Edit Member ----------

    $(document).on('click', '.edit-btn', function () {

        var id = $(this).data('id');

        $.ajax({

            url: '/api/samithimember/get/' + id,

            type: 'GET',

            success: function (response) {

                if (response.success) {

                    var member = response.data;

                    // basic fields
                    $('#memberId').val(member.Id);

                    $('#DesignationType').val(member.DesignationType);

                    $('#Name').val(member.SamithiMember);

                    $('#Email').val(member.Email);

                    $('#PhoneNo').val(member.PhoneNo);

                    $('#Education').val(member.Education);

                    $('#Profession').val(member.Profession);

                    $('#Address').val(member.Address);


                    // ✅ Category set
                    $('#Category').val(member.Category);


                    // ✅ SubCaste load + select
                    loadSubCastes(member.Category, member.Caste);


                    // show modal
                    $('#vidhanSabhaModal').modal('show');

                }

            }

        });

    });


    //$(document).on('click', '.edit-btn', function () {
    //    var id = $(this).data('id');
    //    $.ajax({
    //        url: '/api/samithimember/get/' + id,
    //        type: 'GET',
    //        success: function (response) {
    //            if (response.success) {
    //                var member = response.data;
    //                $('#memberId').val(member.Id);
    //                $('#DesignationType').val(member.DesignationType); // assumes value matches option value
    //                $('#Name').val(member.SamithiMember);
    //                $('#Email').val(member.Email);
    //                $('#PhoneNo').val(member.PhoneNo);
    //                $('#Category').val(member.Category);
    //                $('#Caste').val(member.Caste);
    //                $('#Education').val(member.Education);
    //                $('#Profession').val(member.Profession);
    //                $('#Address').val(member.Address);
    //                // Profile file cannot be pre-filled
    //                $('#vidhanSabhaModal').modal('show');
    //            }
    //        },
    //        error: function (xhr) {

    //            Swal.fire({
    //                icon: 'error',
    //                title: 'Error',
    //                text: xhr.responseJSON?.message || 'Request failed',
    //                confirmButtonColor: '#002147'
    //            });

    //        }

    //    });
    //});

    // ---------- Delete Member ----------
    $(document).on('click', '.delete-btn', function () {

        var id = $(this).data('id'); // ✅ GET ID HERE

        Swal.fire({

            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#002147',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'

        }).then((result) => {

            if (result.isConfirmed) {

                $.ajax({

                    url: '/api/samithimember/delete/' + id,

                    type: 'DELETE',

                    success: function (response) {

                        if (response.success) {

                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted',
                                text: response.message,
                                confirmButtonColor: '#002147'
                            });

                            loadMembers();

                        } else {

                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message
                            });

                        }

                    },

                    error: function () {

                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Delete failed'
                        });

                    }

                });

            }

        });

    });

</script>