@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .form-label {
        margin-bottom: 2px;
    }

    #stateModal .modal-dialog {
        max-width: 500px;
    }

    #stateModal .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }

    .count-link:hover {
        color: #0056b3;
        text-decoration: none;
    }

    .sno-col {
        width: 50px;
        text-align: center;
    }
</style>


<div class="card border-0 shadow-sm rounded-3 ">
    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-navy">Add State-wise Counts</h6>
        <button class="btn btn-sm btn-navy py-1 px-3" onclick="openStateModal()">
            <i class="bi bi-plus-lg me-1"></i> Add State Count
        </button>
    </div>
    <div class="card-body p-2">
        <div class="table-responsive">
            <table id="stateTable" class="table table-hover table-bordered table-sm table-compact-custom w-100">
                <thead>
                    <tr>
                        <th class="text-center sno-col">S.No</th>
                        <th>State Name</th>
                        <th class="text-center">Total Count</th>
                        <th class="text-center">Remaining</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="stateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header .btn-navy py-2 px-3">
                <h6 class="modal-title fw-bold" id="modalTitle">Add State Count</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="stateForm">
                    <input type="hidden" id="Id" value="0">

                    <div class="mb-2">
                        <label class="form-label small fw-bold text-muted">Select State</label>
                        <select class="form-select form-select-sm border-2 shadow-none" id="StateId" required>
                            <option value="">-- Loading States --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Count</label>
                        <input type="number" class="form-control form-control-sm border-2 shadow-none" id="Count" placeholder="0" required min="1">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-navy btn-sm flex-grow-1 fw-bold py-2">
                            <i class="bi bi-check-circle me-1"></i> Save Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="~/Scripts/jquery-3.7.0.min.js"></script>

<script>
    let stateDataTable;
    let loadData;

    loadData = function () {

        // destroy if already initialized
        if ($.fn.DataTable.isDataTable('#stateTable')) {
            $('#stateTable').DataTable().clear().destroy();
        }

        stateDataTable = initPaginatedTable({
            apiUrl: '/api/Admin/getAllStateCount',
            tableSelector: '#stateTable',
            pageSizeSelector: '#pageSize',
            columns: [
                {
                    data: null,
                    className: "text-center",
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                { data: "StateName" },

                {
                    data: "Count",
                    className: "text-center",
                    render: function (data, type, row) {
                        return `
                 <span class="count-link"
                       data-stateid="${row.StateId}"
                       style="cursor:pointer; color:#002147;">
                     ${data}
                 </span>`;
                    }
                },
                {
                    data: "RemainingCount",
                    className: "text-center",
                    render: function (data, type, row) {
                        return `
                       <span class="remaining-link"
                            data-stateid="${row.StateId}"
                             style="cursor:pointer; color:#198754;">
                             ${data}
                       </span>`;
                    }
                },

                {
                    data: "Id",
                    className: "text-center",
                    render: function (id, type, row, meta) {
                        return `
                     <button class="btn btn-sm btn-light border p-1 px-2 me-1"
                         onclick="editStateCount(${id})">
                         <i class="bi bi-pencil-square text-primary"></i>
                     </button>
                     <button class="btn btn-sm btn-light border p-1 px-2"
                         onclick="deleteStateCount(${row.StateId})">
                         <i class="bi bi-trash text-danger"></i>
                     </button>`;
                    }
                }



            ]
        });
    };

    $(document).ready(function () {
        // 1. Dropdown bind karein
        bindStateDropdown();
        loadData();


        $('#stateTable tbody').on('click', '.count-link', function () {
            const stateId = $(this).data('stateid');
            window.location.href = `/Master/addDistrictCount?stateId=${stateId}`;
        });

        // 3. Form Submit (Save/Update)
        $('#stateForm').on('submit', function (e) {
            e.preventDefault();

            let model = {
                Id: parseInt($('#Id').val()),
                StateId: parseInt($('#StateId').val()),
                Count: parseInt($('#Count').val())
            };

            Swal.fire({ title: 'Processing...', didOpen: () => Swal.showLoading() });

            $.ajax({
                url: '/api/Admin/saveStateCount',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(model),
                success: function (res) {
                    if (res.success) {
                        Swal.fire('Success', res.message, 'success').then(() => {
                            $('#stateModal').modal('hide');
                            loadData();
                        });
                    } else {
                        Swal.fire('Error', res.message, 'error');
                    }
                },
                error: function (xhr) {
                    Swal.fire('Error', xhr.responseJSON?.error || 'API connection failed', 'error');
                }
            });
        });
    });

    function bindStateDropdown() {
        $.get('/api/Admin/getAllState', function (res) {
            let options = '<option value="">-- Choose State --</option>';
            if (res.success) {
                res.data.forEach(s => {
                    options += `<option value="${s.StateId}">${s.StateName}</option>`;
                });
            }
            $('#StateId').html(options);
        });
    }

    // Edit Function
    function editStateCount(id) {
        $.get(`/api/Admin/getByIdStateCount?id=${id}`, function (res) {
            if (res.success) {
                $('#Id').val(res.data.Id);
                $('#StateId').val(res.data.StateId);
                $('#Count').val(res.data.Count);
                $('#modalTitle').text('Update State Count');
                $('#stateModal').modal('show');
            }
        });
    }

    // Delete Function
    function deleteStateCount(StateId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You want to delete this record!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/api/Admin/deleteStateCount?StateId=${StateId}`,
                    type: 'DELETE',
                    success: function (res) {
                        if (res.success) {
                            Swal.fire('Deleted!', res.message, 'success')
                                .then(() => {
                                    loadData(); // Full page refresh
                                });
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    },
                    error: function (xhr) {
                        Swal.fire('Error', xhr.responseJSON?.error || 'API connection failed', 'error');
                    }
                });
            }
        });
    }

    function openStateModal() {
        $('#Id').val(0);
        $('#stateForm')[0].reset();
        $('#modalTitle').text('Add State Count');
        $('#stateModal').modal('show');
    }
</script>
