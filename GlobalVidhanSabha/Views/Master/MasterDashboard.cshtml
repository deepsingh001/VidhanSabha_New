@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .chart-container {
        height: 380px; /* 👈 Graph size yaha control kare */
        width: 100%;
        position: relative;
    }

    .card {
        border-radius: 10px;
    }

    canvas {
        width: 100% !important;
        height: 100% !important;
    }
</style>



<div class="container-fluid p-3">
    @*<div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0">System Overview</h5>
        </div>*@

    <div class="row g-2">
        <div class="col-12 col-sm-6 col-xl-3">
            <a href="/Master/AddStatePrabhari" style="text-decoration: none; color: inherit;">
                <div class="stat-card d-flex align-items-center justify-content-between">

                    <div class="icon-box bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-people"></i>
                    </div>

                    <div class="text-end">
                        <h3 class="fw-bold mb-0" id="totalMembers">0</h3>
                        <p class="text-muted mb-0 small">State Prabhari</p>
                    </div>

                </div>
            </a>
        </div>

        @*<div class="col-12 col-sm-6 col-xl-3">
                <a href="/Master/VidhanSabhaRagiter?filter=withPrabhari" style="text-decoration: none; color: inherit;">
                    <div class="stat-card d-flex align-items-center justify-content-between">

                        <div class="icon-box bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-file-check"></i>
                        </div>

                        <div class="text-end">
                            <h3 class="fw-bold mb-0" id="withPrabhari">0</h3>
                            <p class="text-muted mb-0 small">With Prabhari</p>
                        </div>
                    </div>
                </a>
            </div>*@


        @*<div class="col-12 col-sm-6 col-xl-3">
                <a href="/Master/VidhanSabhaRagiter?filter=withoutPrabhari" style="text-decoration: none; color: inherit;">
                    <div class="stat-card d-flex align-items-center justify-content-between" style="cursor:pointer;">

                        <div class="icon-box bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-mic"></i>
                        </div>

                        <div class="text-end">
                            <h3 class="fw-bold mb-0" id="withoutPrabhari">0</h3>
                            <p class="text-muted mb-0 small">Without Prabhari</p>
                        </div>

                    </div>
                </a>
            </div>*@


        <div class="col-12 col-sm-6 col-xl-3">
            <a href="/Master/addStateCount" style="text-decoration: none; color: inherit;">
                <div class="stat-card d-flex align-items-center justify-content-between" style="cursor:pointer;">

                    <div class="icon-box bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-bank fs-5 text-primary"></i>
                    </div>

                    <div class="text-end">
                        <h3 class="fw-bold mb-0" id="TotalUsedStates">0</h3>
                        <p class="text-muted mb-0 small">Total States</p>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
            <a href="/Master/addDistrictCount" style="text-decoration: none; color: inherit;">
                <div class="stat-card d-flex align-items-center justify-content-between" style="cursor:pointer;">

                    <div class="icon-box bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-geo-alt fs-5 "></i>
                    </div>

                    <div class="text-end">
                        <h3 class="fw-bold mb-0" id="TotalUsedDistrict">0</h3>
                        <p class="text-muted mb-0 small">Total District</p>
                    </div>
                </div>
            </a>
        </div>


        <div class="col-12 col-sm-6 col-xl-3">
            <a href="/Master/addDesignation" style="text-decoration: none; color: inherit;">
                <div class="stat-card d-flex align-items-center justify-content-between" style="cursor:pointer;">

                    <div class="icon-box bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-geo-alt fs-5 "></i>
                    </div>

                    <div class="text-end">
                        <h3 class="fw-bold mb-0" id="TotalDesignationName">0</h3>
                        <p class="text-muted mb-0 small">Total Designation</p>
                    </div>
                </div>
            </a>
        </div>




        <div class="row g-2 mt-2">

            <!-- State Chart -->
            <div class="col-md-6 stateChartDiv">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">State Wise Count</h6>
                        <div class="chart-container">
                            <canvas id="stateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- District Chart -->
            <div class="col-md-6 districtChartdiv">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">District Wise Count</h6>
                        <div class="chart-container">
                            <canvas id="districtChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>



    </div>

</div>



<script src="~/Scripts/jquery-3.7.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let stateChart;
let districtChart;

const colors = [
    '#36a2eb',
    '#ff6384',
    '#4bc0c0',
    '#ff9f40',
    '#9966ff',
    '#ffcd56',
    '#c9cbcf',
    '#8dd17e',
    '#ff8a65',
    '#9575cd'
];

$(document).ready(function () {

    loadStateChart();
    loadDistrictChart();

});


// ================= STATE CHART (NOW BAR CHART) =================

    function loadStateChart() {

        $.ajax({
            url: '/api/Admin/getAllStateCount?PageNumber=1&Items=1000&search=',
            type: 'GET',

            success: function (response) {

                if (!response.success) return;

                let list = response.data.data;

                // sort descending
                list.sort((a, b) => b.Count - a.Count);

                // take top 10
                let top = list.slice(0, 10);

                // remaining sum
                let others = list.slice(10)
                    .reduce((sum, x) => sum + x.Count, 0);

                if (others > 0) {
                    top.push({
                        StateName: "Others",
                        Count: others,
                        RemainingCount: 0
                    });
                }

                const labels = top.map(x => x.StateName);
                const usedCounts = top.map(x => x.Count);
                const remainingCounts = top.map(x => x.RemainingCount);

                if (stateChart)
                    stateChart.destroy();

                stateChart = new Chart(
                    document.getElementById('stateChart'),
                    {
                        type: 'bar',

                        data: {
                            labels: labels,

                            datasets: [
                                {
                                    label: 'Used',
                                    data: usedCounts,
                                    backgroundColor: '#36a2eb'
                                },
                                {
                                    label: 'Remaining',
                                    data: remainingCounts,
                                    backgroundColor: '#ff6384'
                                }
                            ]
                        },

                        options: {

                            indexAxis: 'y', // horizontal

                            responsive: true,

                            maintainAspectRatio: false,

                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },

                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );

            }
        });

    }



// ================= DISTRICT CHART (NOW PIE CHART) =================

    function loadDistrictChart() {

        $.ajax({
            url: '/api/Admin/getAllDistict?PageNumber=1&Items=5000&search=',
            type: 'GET',

            success: function (response) {

                if (!response.success) return;

                let list = response.data.data;

                list.sort((a, b) => b.Count - a.Count);

                let top = list.slice(0, 15);

                const labels = top.map(x => x.DistrictName);

                const usedCounts = top.map(x => x.Count);

                const remainingCounts = top.map(x => x.RemainingCount);

                if (districtChart)
                    districtChart.destroy();

                districtChart = new Chart(
                    document.getElementById('districtChart'),
                    {
                        type: 'bar',

                        data: {
                            labels: labels,

                            datasets: [
                                {
                                    label: 'Used',
                                    data: usedCounts,
                                    backgroundColor: '#4bc0c0'
                                },
                                {
                                    label: 'Remaining',
                                    data: remainingCounts,
                                    backgroundColor: '#ff9f40'
                                }
                            ]
                        },

                        options: {

                            indexAxis: 'y',

                            responsive: true,

                            maintainAspectRatio: false,

                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },

                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );

            }
        });

    }

</script>

<script>
    $(document).ready(function () {
        function loadDashboardCounts() {
            $.ajax({
                url: '/api/Admin/GetDashboardCounts',
                type: 'GET',
                success: function (response) {
                    // Nested data path fix
                    if (response.success && response.data.success) {
                        var counts = response.data.data;

                        $('#totalMembers').text(counts.TotalStatePrabhari);
                        //$('#withPrabhari').text(counts.TotalVidhanSabhaWithPrabhari);
                        //$('#withoutPrabhari').text(counts.TotalVidhanSabhaWithoutPrabhari);
                        $('#TotalUsedStates').text(counts.TotalUsedStates);
                        $('#TotalUsedDistrict').text(counts.TotalUsedDistrict);
                        $('#TotalDesignationName').text(counts.TotalDesignationName);


                    } else {
                        console.error('Failed to fetch dashboard counts');
                    }
                },
                error: function (err) {
                    console.error('Error:', err);
                }
            });
        }

        loadDashboardCounts();
    });
</script>

